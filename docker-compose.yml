version: "3.9"

services:
  # ---------- Backend (FastAPI / Python) ----------
  backend:
    build:
      context: ./line-back-end      # path ไปยัง folder backend
      dockerfile: Dockerfile        # ใช้ Dockerfile นี้
    container_name: line_backend
    ports:
      - "8000:8000"                 # forward port 8000
    environment:
      - PYTHONUNBUFFERED=1          # ป้องกัน buffer log
    volumes:
      - ./line-back-end:/app        # สำหรับ hot-reload ใน dev (optional)
    restart: unless-stopped

  # ---------- Frontend (Next.js / Node.js) ----------
  frontend:
    build:
      context: ./line-front-end
      dockerfile: Dockerfile
      # [เพิ่ม] 1. บอกให้ Docker ใช้ stage "builder" จาก Dockerfile ของคุณ
      # (เพราะ stage นี้มี dev dependencies ที่จำเป็นสำหรับ npm run dev)
      target: builder
    container_name: line_frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_TELEMETRY_DISABLED=1
    depends_on:
      - backend
    
    # [เพิ่ม] 2. ซิงค์ไฟล์โค้ดของคุณเข้าไปใน Container
    volumes:
      # ซิงค์โฟลเดอร์โค้ดของคุณ (./line-front-end) ไปที่ /app ใน Docker
      - ./line-front-end:/app
      # "อย่า" ซิงค์ node_modules จากเครื่องคุณเข้าไป ให้ใช้ของที่อยู่ใน Docker
      - /app/node_modules
      # "อย่า" ซิงค์ .next จากเครื่องคุณ ให้ Docker สร้างเองข้างใน
      - /app/.next

    # [เพิ่ม] 3. บังคับให้รัน dev server (แทน npm run start)
    command: npm run dev


  # ---------- Cloudflare Tunnel ----------
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run 
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}

# You can re-enable networks if you need them
# networks:
#   default: